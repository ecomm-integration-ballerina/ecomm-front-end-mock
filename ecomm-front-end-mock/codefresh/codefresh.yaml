version: '1.0'
steps:
  setting_permissions:
    image: bash
    commands:
      - chmod -R 777 /codefresh/volume
  
  build_package:
    title: Building Ecomm Front End Mock
    image: ballerina/ballerina-platform:0.981.1
    fail_fast: true
    commands:
    - ballerina init
    - ballerina build ecomm-front-end-mock
  
  build_image:
    title: Building Docker Image
    type: build
    image_name: rajkumar/ecomm-front-end-mock
    working_directory: ./target/kubernetes/ecomm-front-end-mock/docker/
    tag: 0.1.0
    dockerfile: Dockerfile

  push_image:
    title: Pushing to Docker Registry
    type: push
    candidate: '${{BuildingDockerImage}}'
    tag: 0.1.0
    registry: dockerhub  

  deploy_to_k8s:
    title: Deploying ballerina-generated k8s artifacts
    image: 'codefresh/kube-helm:master'
    commands:
      - whoami
      - cat ${{CF_VOLUME_PATH}}/ecomm-front-end-mock/target/kubernetes/ecomm-front-end-mock/ecomm-front-end-mock_deployment.yaml
      - kubectl config use-context ecomm-integration-ballerina@ecomm-integration-ballerina
      - kubectl delete -f ${{CF_VOLUME_PATH}}/ecomm-front-end-mock/target/kubernetes/ecomm-front-end-mock/ecomm-front-end-mock_deployment.yaml 
      - kubectl apply -f ${{CF_VOLUME_PATH}}/ecomm-front-end-mock/target/kubernetes/ecomm-front-end-mock  